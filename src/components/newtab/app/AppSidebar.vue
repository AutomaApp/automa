<template>
  <aside
    class="fixed left-0 top-0 z-50 flex h-screen w-16 flex-col items-center bg-white py-6 dark:bg-gray-800"
  >
    <img
      :title="`v${extensionVersion}`"
      src="@/assets/svg/logo.svg"
      class="mx-auto mb-4 w-10"
    />
    <div
      class="relative w-full space-y-2 text-center"
      @mouseleave="showHoverIndicator = false"
    >
      <div
        v-show="showHoverIndicator"
        ref="hoverIndicator"
        class="bg-box-transparent absolute left-1/2 h-10 w-10 rounded-lg transition-transform duration-200"
        style="transform: translate(-50%, 0)"
      ></div>
      <router-link
        v-for="tab in tabs"
        v-slot="{ href, navigate, isActive }"
        :key="tab.id"
        :to="tab.path"
        custom
      >
        <a
          v-tooltip:right.group="
            `${t(`common.${tab.id}`, 2)} ${
              tab.shortcut && `(${tab.shortcut.readable})`
            }`
          "
          :class="{ 'is-active': isActive }"
          :href="tab.id === 'log' ? '#' : href"
          class="tab relative z-10 flex w-full items-center justify-center"
          @click="navigateLink($event, navigate, tab)"
          @mouseenter="hoverHandler"
        >
          <div class="inline-block rounded-lg p-2 transition-colors">
            <v-remixicon :name="tab.icon" />
          </div>
          <span
            v-if="tab.id === 'log' && runningWorkflowsLen > 0"
            class="absolute -top-1 right-2 h-4 w-4 rounded-full bg-accent text-xs text-white dark:text-black"
          >
            {{ runningWorkflowsLen }}
          </span>
        </a>
      </router-link>
    </div>
    <hr class="my-4 w-8/12" />
    <button
      v-tooltip:right.group="$t('home.elementSelector.name')"
      class="focus:ring-0"
      @click="injectElementSelector"
    >
      <v-remixicon name="riFocus3Line" />
    </button>
    <div class="grow"></div>

    <!--  用户信息  -->
    <ui-popover
      v-if="userStore.user"
      trigger="mouseenter click"
      placement="right"
    >
      <template #trigger>
        <span class="bg-box-transparent inline-block rounded-full p-1">
          <!--          <img-->
          <!--            :src="userStore.user.avatar_url"-->
          <!--            height="32"-->
          <!--            width="32"-->
          <!--            class="rounded-full"-->
          <!--          />-->
          <div
            style="
              width: 32px;
              height: 32px;
              display: flex;
              align-items: center;
              justify-content: center;
            "
          >
            匿
          </div>
        </span>
      </template>
      <div class="w-44">
        <div class="flex items-center">
          <p class="text-overflow flex-1">
            {{ userStore.user.username }}
          </p>
          <span
            title="Subscription"
            :class="subColors[userStore.user.subscription]"
            class="rounded-md px-2 py-1 text-sm capitalize"
          >
            {{ userStore.user.subscription }}
          </span>
        </div>
      </div>
    </ui-popover>

    <ui-popover trigger="mouseenter" placement="right" class="my-4">
      <template #trigger>
        <v-remixicon name="riGroupLine" />
      </template>
      <p class="mb-2">
        {{ t('home.user') }}
      </p>
      <ui-list class="w-40 user-center">
        <template v-if="userStore.user">
          <!--          <ui-list-item small>-->
          <!--            {{ t('home.userCenter.modify') }}-->
          <!--          </ui-list-item>-->
          <!--          <ui-list-item small>-->
          <!--            {{ t('home.userCenter.resetPasswd') }}-->
          <!--          </ui-list-item>-->
          <!--          <ui-list-item small @click="onLogoutClick">-->
          <!--            {{ t('home.userCenter.logout') }}-->
          <!--          </ui-list-item>-->
        </template>
        <template v-else>
          <ui-list-item small @click="onRegisterClick">
            {{ t('home.userCenter.register') }}
          </ui-list-item>
          <!--          <ui-list-item small>-->
          <!--            {{ t('home.userCenter.signIn') }}-->
          <!--          </ui-list-item>-->
        </template>
      </ui-list>
    </ui-popover>
    <router-link v-tooltip:right.group="t('settings.menu.about')" to="/about">
      <v-remixicon class="cursor-pointer" name="riInformationLine" />
    </router-link>
  </aside>
</template>
<script setup>
import { ref, computed } from 'vue';
import { useI18n } from 'vue-i18n';
import { useRouter } from 'vue-router';
import { useToast } from 'vue-toastification';
import browser from 'webextension-polyfill';
import { useUserStore } from '@/stores/user';
import { useWorkflowStore } from '@/stores/workflow';
import { useShortcut, getShortcut } from '@/composable/shortcut';
import { useGroupTooltip } from '@/composable/groupTooltip';
import { initElementSelector } from '@/newtab/utils/elementSelector';
import emitter from '@/lib/mitt';
import { fetchApi } from '@/utils/api';

useGroupTooltip();

const { t } = useI18n();
const toast = useToast();
const router = useRouter();
const userStore = useUserStore();
const workflowStore = useWorkflowStore();

const extensionVersion = browser.runtime.getManifest().version;
const subColors = {
  free: 'bg-box-transparent',
  pro: 'bg-accent text-white',
  business: 'bg-accent text-white dark:text-black',
};
const tabs = [
  {
    id: 'workflow',
    icon: 'riFlowChart',
    path: '/workflows',
    shortcut: getShortcut('page:workflows', '/workflows'),
  },
  {
    id: 'packages',
    icon: 'mdiPackageVariantClosed',
    path: '/packages',
    shortcut: '',
  },
  {
    id: 'schedule',
    icon: 'riTimeLine',
    path: '/schedule',
    shortcut: getShortcut('page:schedule', '/triggers'),
  },
  {
    id: 'storage',
    icon: 'riHardDrive2Line',
    path: '/storage',
    shortcut: getShortcut('page:storage', '/storage'),
  },
  {
    id: 'log',
    icon: 'riHistoryLine',
    path: '/logs',
    shortcut: getShortcut('page:logs', '/logs'),
  },
  {
    id: 'settings',
    icon: 'riSettings3Line',
    path: '/settings',
    shortcut: getShortcut('page:settings', '/settings'),
  },
];
const hoverIndicator = ref(null);
const showHoverIndicator = ref(false);
const runningWorkflowsLen = computed(() => workflowStore.getAllStates.length);

useShortcut(
  tabs.reduce((acc, { shortcut }) => {
    if (shortcut) {
      acc.push(shortcut);
    }

    return acc;
  }, []),
  ({ data }) => {
    if (!data) return;

    if (data.includes('/logs')) {
      emitter.emit('ui:logs', { show: true });
      return;
    }

    router.push(data);
  }
);

function navigateLink(event, navigateFn, tab) {
  event.preventDefault();

  if (tab.id === 'log') {
    emitter.emit('ui:logs', { show: true });
  } else {
    navigateFn();
  }
}
function hoverHandler({ target }) {
  showHoverIndicator.value = true;
  hoverIndicator.value.style.transform = `translate(-50%, ${target.offsetTop}px)`;
}
async function injectElementSelector() {
  try {
    const [tab] = await browser.tabs.query({ active: true, url: '*://*/*' });
    if (!tab) {
      toast.error(t('home.elementSelector.noAccess'));
      return;
    }

    await initElementSelector();
  } catch (error) {
    console.error(error);
  }
}

async function onRegisterClick() {
  const response = await fetchApi('/user/register', { method: 'POST' });
  const result = await response.json();
  if (!response.ok) throw new Error(response.message);
  if (result.code) throw new Error(result.msg);

  let user = result.data;
  user = {
    ...user,
    username: user.nick || user.name,
  };
  browser.storage.local.set({
    user,
  });
  browser.storage.local.set({ access_token: user.access_token });
  userStore.user = user;
}

// async function onLogoutClick() {
//   browser.storage.local.remove(['user', 'access_token']);
//   userStore.user = null;
// }
</script>
<style scoped>
.tab.is-active:after {
  content: '';
  position: absolute;
  right: 0;
  top: 0;
  height: 100%;
  width: 4px;
  @apply bg-accent dark:bg-gray-100;
}
.user-center {
  > * {
    cursor: pointer;
  }
}
</style>
